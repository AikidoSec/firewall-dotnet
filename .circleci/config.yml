version: 2.1

orbs:
  win: circleci/windows@5.0

jobs:
  checkout_code:
    docker:
      - image: cimg/base:2022.08
    steps:
      - checkout
      - run:
          name: Generate Package References Checksum
          command: bash ./.circleci/generate-packages-checksum.sh
      - persist_to_workspace:
          root: .
          paths:
            - .
            - packages.txt
            - packages.checksum

  e2e_test:
    parameters:
      dotnet_version:
        type: string
    executor:
      name: win/server-2022
    environment:
      ROOT_DIR: ${CIRCLE_WORKING_DIRECTORY}
      CI: true
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Install dotnet tools
          command: dotnet tool restore
      - run:
          name: Download zen binaries
          command: cake --target DownloadLibraries
      - restore_cache:
          keys:
            - nuget-packages-v2-{{ checksum "packages.checksum" }}
            - nuget-packages-v2-
          paths:
            - packages
            - ~/.nuget/packages
      - run:
          name: Restore NuGet Packages
          command: nuget restore
      - run:
          name: Build
          command: |
            $msbuildPath = "C:\Program Files\Microsoft Visual Studio\2022\Community\MSBuild\Current\Bin\MSBuild.exe"
            & $msbuildPath
      - save_cache:
          name: Cache Nuget Packages
          key: nuget-packages-v2-{{ checksum "packages.checksum" }}
          paths:
            - packages
            - ~/.nuget/packages
      - run:
          name: Create SQL LocalDB
          command: sqllocaldb create "mssqllocaldb"
      - run:
          name: Run E2E Tests
          command: |
            dotnet test "Aikido.Zen.Test.End2End/Aikido.Zen.Test.End2End.csproj" `
              --configuration Release `
              --output "TestResults" `
              --logger "console;"
      - store_test_results:
          path: TestResults
      - store_artifacts:
          path: TestResults

workflows:
  test_on_pr:
    jobs:
      - checkout_code
      - e2e_test:
          requires:
            - checkout_code
          matrix:
            parameters:
              dotnet_version: ["6.0", "7.0", "8.0"]
