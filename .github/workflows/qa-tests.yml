name: ðŸ§ª QA Tests
permissions:
  contents: read
on:
  push: {}
  workflow_call: {}

jobs:
  qa-tests:
    runs-on: windows-2022
    timeout-minutes: 30
    steps:
      - name: Checkout firewall-dotnet
        uses: actions/checkout@v4
        with:
          path: firewall-dotnet

      - name: Checkout zen-demo-dotnet-core
        uses: actions/checkout@v4
        with:
          repository: Aikido-demo-apps/zen-demo-dotnet-core
          ref: qa-endpoints
          path: zen-demo-dotnet-core
          submodules: true

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Add msbuild to PATH
        uses: microsoft/setup-msbuild@v2
        with:
          vs-version: "[17.2,19.0)"

      - name: Install Cake Tool
        run: dotnet tool install --global Cake.Tool

      - name: Build firewall-dotnet package
        run: |
          cd firewall-dotnet

          # Install dependencies
          dotnet tool restore
          dotnet restore

          # Run Cake Script to Build and Pack
          dotnet cake build.cake --target=CreatePackages --configuration=Release --libVersion=0.0.0-qa

          # Create local-feed directory in zen-demo-dotnet-core and move the packed nupkg
          New-Item -ItemType Directory -Force -Path ../zen-demo-dotnet-core/local-feed
          Move-Item -Path ./artifacts/*.nupkg -Destination ../zen-demo-dotnet-core/local-feed/
        shell: pwsh

      - name: Replace Dockerfile with QA version
        run: |
          Copy-Item -Path firewall-dotnet/.github/workflows/Dockerfile.qa -Destination zen-demo-dotnet-core/Dockerfile
        shell: pwsh

      - name: Run Firewall QA Tests
        uses: AikidoSec/firewall-tester-action@releases/v1
        with:
          dockerfile_path: ./zen-demo-dotnet-core/Dockerfile
          app_port: 8080
          sleep_before_test: 10
