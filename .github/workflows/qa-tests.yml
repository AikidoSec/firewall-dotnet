name: ðŸ§ª QA Tests
permissions:
  contents: read
on:
  push: {}
  workflow_call: {}

jobs:
  qa-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout firewall-dotnet
        uses: actions/checkout@v4
        with:
          path: firewall-dotnet

      - name: Checkout zen-demo-dotnet-core
        uses: actions/checkout@v4
        with:
          repository: Aikido-demo-apps/zen-demo-dotnet-core
          ref: qa-endpoints
          path: zen-demo-dotnet-core
          submodules: true

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Install Cake Tool
        run: dotnet tool install --global Cake.Tool

      - name: Build firewall-dotnet package
        run: |
          cd firewall-dotnet

          # Install dependencies
          dotnet tool restore
          dotnet restore

          # Run Cake Script to Build and Pack
          dotnet cake build.cake --target=CreatePackages --configuration=Release --libVersion=0.0.0-qa

          # Create local-feed directory in zen-demo-dotnet-core and move the packed nupkg
          mkdir -p ../zen-demo-dotnet-core/local-feed
          mv ./artifacts/*.nupkg ../zen-demo-dotnet-core/local-feed/

      - name: Replace Dockerfile with QA version
        run: |
          cp firewall-dotnet/.github/workflows/Dockerfile.qa zen-demo-dotnet-core/Dockerfile

      - name: Run Firewall QA Tests
        uses: AikidoSec/firewall-tester-action@releases/v1
        with:
          dockerfile_path: ./zen-demo-dotnet-core/Dockerfile
          app_port: 8080
          sleep_before_test: 10
